jobs:
  - job: BuildAndPublish
    displayName: "Version & Tag"
    steps:
      - checkout: self
        persistCredentials: true
        fetchDepth: 0

      - task: UseDotNet@2
        inputs:
          packageType: "sdk"
          version: "6.x"
          installationPath: $(Agent.ToolsDirectory)/dotnet

      - script: |
          dotnet tool install --global GitVersion.Tool
          export PATH="$PATH:~/.dotnet/tools"
          dotnet-gitversion /output json /output buildserver
        displayName: "Determine Version"

      - script: |
          echo "##vso[task.setvariable variable=GitVersionFullSemVer;isOutput=true]$(GitVersion.FullSemVer)"
          echo "##vso[task.setvariable variable=GitVersionMajorMinorPatch;isOutput=true]$(GitVersion.MajorMinorPatch)"
          echo "$(GitVersion.MajorMinorPatch)" > gitversion.txt
        displayName: "Set GitVersion Variables"
        name: setVersion
      - bash: |
          echo '__version__ = "$(GIT_VERSION)"' > {{.project_name}}/__init__.py
        displayName: "Set version in {{.project_name}}/__init__.py"

      - task: PublishBuildArtifacts@1
        inputs:
          PathtoPublish: "gitversion.txt"
          ArtifactName: "GitVersion"
          publishLocation: "Container"
        displayName: "Publish gitversion.txt as an artifact"

      - script: |
          echo "GitVersion.FullSemVer: $(GitVersion.FullSemVer)"
          echo "GitVersion.MajorMinorPatch: $(GitVersion.MajorMinorPatch)"
          git tag $(GitVersion.FullSemVer)
          git push origin $(GitVersion.FullSemVer)
        displayName: "Create FullSemVer Tag"

      - script: |
          if [ "$(Build.SourceBranch)" == "refs/heads/main" ]; then
            git tag $(GitVersion.MajorMinorPatch)
            git push origin $(GitVersion.MajorMinorPatch)
          fi
        displayName: "Create MajorMinorPatch Tag if on Main Branch"

      - bash: |
          zip -r $(Build.ArtifactStagingDirectory)/DAB-$(Build.BuildId).zip ./*
        displayName: "Zip artifact"

      - publish: $(Build.ArtifactStagingDirectory)/DAB-$(Build.BuildId).zip
        artifact: DAB-$(Build.BuildId)
        displayName: "Pubish bundle artifact"
